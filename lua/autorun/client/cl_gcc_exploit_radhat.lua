--[[
Do some funny things with people that try to use server exploits.

Sources:
Radhat systemd gcc exploit virus: https://www.youtube.com/watch?v=EP7bIiTULts
Bad net messages 1: https://www.unknowncheats.me/forum/4310777-post7.html
Bad net messages 2: https://www.unknowncheats.me/forum/2801727-post1.html
]]

---@diagnostic disable: inject-field

---@param value number
---@param loop_high number
---@return number
local function loopValue(value, loop_high)
	local num = math.floor(value/loop_high)
	return value-num*loop_high
end

local exploit_msgs =
{
	"aze46aez67z67z64dcv4bt",
	"verifiopd",
	"mathislebg",
	"enablevac",
	"GMBG:PickupItem",
	"audisquad_lua",
	"Remove_Exploiters",
	"PlayerItemPickUp",
	"xenoserverfunction",
	"random",
	"AbSoluT",
	"fancyscoreboard_leave",
	"m9k_explosive",
	"DarkRP_Gamemodes",
	"yohsambresicianatik<3",
	"shix",
	"PDA_DRM_REQUEST_CONTENT",
	"Fix_Keypads",
	"nolag",
	"something",
	"xenoreceivetargetdata1",
	"memeDoor",
	"slua",
	"_main",
	"m9k_explosionradius",
	"AidsTacos",
	"noclipcloakaesp_chat_text",
	"EnigmaIsthere",
	"_Defqon",
	"waoz",
	"ZimbaBackdoor",
	"ITEM",
	"thefrenchenculer",
	"xenoclientdatafunction",
	"Ulogs_Infos",
	"JSQuery.Data(Post(false))",
	"Bilboard.adverts:Spawn(false)",
	"thereaper",
	"DarkRP_Armors",
	"changename",
	"disablebackdoor",
	"Backdoor",
	"strip0",
	"ULX_QUERY_TEST2",
	"ULXQUERY2",
	"reaper",
	"SetPlayerDeathCount",
	"Im_SOCool",
	"Sandbox_ArmDupe",
	"adsp_door_length",
	"_Raze",
	"lag_ping",
	"Dominos",
	"fijiconn",
	"PRDW_GET",
	"[removed]ed",
	"c",
	"AnalCavity",
	"MoonMan",
	"FADMIN_ANTICRASH",
	"LickMeOut",
	"_Warns",
	"ReadPing",
	"SessionBackdoor",
	"cvaraccess",
	"EnigmaProject",
	"jesuslebg",
	"BetStrep",
	"music",
	"rcivluz",
	"xenoserverdatafunction",
	"LuaCmd",
	"ULX_QUERY2",
	"striphelper",
	"killserver",
	"DarkRP_AdminWeapons",
	"DarkRP_UTF8",
	"FPSBOOST",
	"_Battleye_Meme_",
	"PlayerKilledLogged",
	"xenoexistscl",
	"DarkRP_Money_System",
	"Sbox_gm_attackofnullday_key",
	"UKT_MOMOS",
	"fourhead",
	"_Defcon",
	"88",
	"nostrip",
	"SparksLeBg",
	"legrandguzmanestla",
	"samosatracking57",
	"stream",
	"MJkQswHqfZ",
	"Î¾psilon",
	"_CAC_ReadMemory",
	"xuy",
	"R8",
	"ALTERED_CARB0N",
	"The_DankWhy",
	"nw.readstream",
	"OdiumBackDoor",
	"anticrash",
	"xenoreceivetargetdata2",
	"awarn_remove",
	"mecthack",
	"ULX_ANTI_BACKDOOR",
	"__G____CAC",
	"Weapon_88",
	"DarkRP_ReceiveData",
	"ULogs_B",
	"FAdmin_Notification_Receiver",
	"Ulx_Error_88",
	"PlayerCheck",
	"The_Dankwoo",
	"pwn_http_send",
	"pwn_http_answer",
	"gag",
	"pwn_wake",
	"Inj3",
	"Sandbox_GayParty",
	"Abcdefgh",
	"INJ3v4",
	"Sbox_darkrp",
	"xenoclientfunction",
	"Sbox_Message",
	"xenoactivation",
	"N::B::P",
	"DOGE",
	"negativedlebest",
	"theberettabcd",
	"componenttolua",
	"berettabest",
	"antiexploit",
	"FPP_AntiStrip",
	"rconadmin",
	"kek",
	"JQerystrip.disable",
	"adm_network",
	"fellosnake",
	"ZernaxBackdoor",
	"_cac_",
	"nocheat",
	"GMOD_NETDBG",
	"echangeinfo",
	"SENDTEST",
	"[removed]",
	"Ulib_Message",
	"BOOST_FPS",
	"_blacksmurf",
	"elfamosabackdoormdr",
	"NoOdium_ReadPing",
	"_GaySploit",
	"GaySploitBackdoor",
	"DefqonBackdoor",
	"[removed]server",
	"noprop",
	"stoppk",
	"Sbox_itemstore",
	"_clientcvars",
	"arivia",
	"dontforget",
	"pjHabrp9EY",
	"idk",
	"||||",
	"NoNerks",
	"OldNetReadData",
	"jeveuttonrconleul",
	"blacksmurfBackdoor",
}


---@type IGModAudioChannel?
local exploit_sound_channel = nil

local exploit_started = false

local function displayBackdoor()
	local panel = vgui.Create("DPanel")
	panel:MakePopup()
	panel:Dock(FILL)
	panel:SetBackgroundColor(Color(0,100, 0, 255))
	local model = panel:Add("DModelPanel")
	model:SetSize(ScrW()/2, 0)
	model:Dock(LEFT)
	model:SetModel("models/Kleiner.mdl")
	---@param ent Entity
	function model:LayoutEntity(ent)
		ent:SetMaterial("models/wireframe")
		ent:SetSequence(0)
		ent:SetAngles(Angle(0,CurTime()*200,0))
		ent:SetPos(Vector(0,0,0))
	end
	local og_paint = panel.Paint
	function panel:Paint(w,h)
		og_paint(self, w, h)
		surface.SetFont("DebugFixed")
		surface.SetTextColor(0, 255, 0, 255)
		local char_width, char_height = surface.GetTextSize("00000000000000000000000000000000")

		for i = 1, math.floor(h/char_height) do
			surface.SetTextPos(ScrW()/2+char_width*0, loopValue(i*char_height, h))
			surface.DrawText(exploit_msgs[math.random(#exploit_msgs)])
		end
		for i = 1, math.floor(h/char_height) do
			surface.SetTextPos(ScrW()/2+char_width*1, loopValue(i*char_height, h))
			surface.DrawText(exploit_msgs[math.random(#exploit_msgs)])
		end
		for i = 1, math.floor(h/char_height) do
			surface.SetTextPos(ScrW()/2+char_width*2, loopValue(i*char_height, h))
			surface.DrawText(exploit_msgs[math.random(#exploit_msgs)])
		end

		--for index, value in ipairs(exploit_msgs) do
		--	surface.SetTextPos(ScrW()/2, loopValue(index*char_height, h))
		--	surface.DrawText(value)
		--end
	end
	local cia_logo = panel:Add("DImage")
	cia_logo:SetSize(128, 128)
	cia_logo:SetPos(ScrW()-128, ScrH()-128)
	-- We can check if the file exists and don't download if it does, but what if I want to edit the file?
	http.Fetch("https://raw.githubusercontent.com/FreeSBox/streamed-files/master/cia_seal.png", function (body, size, headers, code)
		if not file.IsDir("freesbox", "DATA") then
			file.CreateDir("freesbox")
		end
		file.Write("freesbox/cia_seal.png", body)
		timer.Simple(0.5, function ()
			cia_logo:SetImage("data/freesbox/cia_seal.png")
		end)
	end)
	http.Fetch("https://raw.githubusercontent.com/FreeSBox/streamed-files/master/gcc_exploit_systemd.mp3", function (body, size, headers, code)
		if not file.IsDir("freesbox", "DATA") then
			file.CreateDir("freesbox")
		end
		file.Write("freesbox/gcc_exploit_systemd.mp3", body)
		sound.PlayFile("data/freesbox/gcc_exploit_systemd.mp3", "mono noblock", function (channel, errorID, errorName)
			if ( IsValid( channel ) ) then
				channel:SetPos(LocalPlayer():GetPos())
				channel:Play()
				exploit_sound_channel = channel
			else
				print( "Error playing sound!", errorID, errorName )
			end
		end)
	end)
	hook.Add("Think", "virus_wait_for_sound", function ()
		if exploit_sound_channel and exploit_sound_channel:GetLength() == exploit_sound_channel:GetTime() then
			panel:Remove()
			hook.Remove("Think", "virus_wait_for_sound")

			net.Start("virusDetected")
			net.SendToServer()
		end
	end)
end

net.Receive("virusDetected", function (len, ply)
	if not exploit_started then
		displayBackdoor()
		exploit_started = true
	end
end)

